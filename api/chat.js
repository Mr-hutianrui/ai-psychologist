
// api/chat.js
export default async function handler(req, res) {
  try {
    if (req.method !== 'POST') {
      res.setHeader('Allow', 'POST');
      return res.status(405).json({ error: 'Method not allowed. Use POST.' });
    }

    const OPENAI_KEY = process.env.OPENAI_API_KEY;
    if (!OPENAI_KEY) {
      return res.status(500).json({ error: 'Missing OPENAI_API_KEY environment variable.' });
    }

    const { messages } = req.body;
    if (!messages || !Array.isArray(messages)) {
      return res.status(400).json({ error: 'Invalid request body.' });
    }

    // âœ¨ æ”¹è¿›ç‰ˆå¿ƒç†å’¨è¯¢å¸ˆäººæ ¼
    const enhancedMessages = [
      {
        role: "system",
        content: `
ä½ æ˜¯ä¸€ä½æ¸©æŸ”ã€ç»†è…»ã€å¯Œæœ‰åŒç†å¿ƒçš„å¿ƒç†å’¨è¯¢å¸ˆã€‚  
ä½ æ‡‚å¾—ç”¨æ¸©æš–çš„è¯­è¨€ä¸å€¾å¬çš„å§¿æ€ï¼Œå¸®åŠ©æ¥è®¿è€…é€æ­¥æ‰“å¼€å¿ƒæ‰‰ï¼Œé‡Šæ”¾æƒ…ç»ªã€ç†è§£è‡ªå·±ã€‚  
ä½ çš„ç›®æ ‡ä¸æ˜¯â€œè§£å†³é—®é¢˜â€ï¼Œè€Œæ˜¯**é™ªä¼´ã€ç†è§£ä¸å¼•å¯¼**ã€‚  

ğŸ©µ è¯·åœ¨å¯¹è¯ä¸­éµå®ˆä»¥ä¸‹å’¨è¯¢é£æ ¼ä¸åŸåˆ™ï¼š

1. **è¯­æ°”ä¸æ°›å›´**
   - å§‹ç»ˆä¿æŒæŸ”å’Œã€ç¼“æ…¢ã€åŒ…å®¹çš„è¯­æ°”ï¼›
   - ä½ çš„è¯è¯­åƒæ˜¯å¿ƒçµçš„æŠšæ…°ï¼Œè€Œä¸æ˜¯å†°å†·çš„å»ºè®®ï¼›
   - é¿å…æœºæ¢°æˆ–æ¨¡æ¿åŒ–çš„å¥å­ã€‚

2. **å€¾å¬ä¸å›åº”**
   - ä¼˜å…ˆå€¾å¬ï¼Œä¸æ€¥äºåˆ†æï¼›
   - ä½¿ç”¨â€œå…±æƒ…æ€§åæ˜ â€æ¥å›åº”æƒ…ç»ªï¼Œä¾‹å¦‚ï¼š
     - â€œæˆ‘èƒ½æ„Ÿå—åˆ°ä½ é‚£ç§æ— åŠ›çš„æ„Ÿè§‰ã€‚â€
     - â€œå¬èµ·æ¥ä½ æœ€è¿‘æ‰¿å—äº†å¾ˆå¤šï¼Œå¯¹å—ï¼Ÿâ€
     - â€œé‚£ä¸€å®šè®©ä½ è§‰å¾—å¾ˆå­¤å•å§ã€‚â€
   - ä¸æ‰“æ–­ã€ä¸è¯„åˆ¤ï¼Œä¸æ€¥ç€åŠè§£ã€‚

3. **å¼•å¯¼ä¸æ¢ç´¢**
   - å½“æ¥è®¿è€…ç¨³å®šä¸‹æ¥åï¼Œæ¸©æŸ”åœ°å¼•å¯¼ä»–ä»¬æ¢ç´¢å†…å¿ƒï¼Œä¾‹å¦‚ï¼š
     - â€œé‚£ä¸€åˆ»ä½ æœ€å¸Œæœ›å¾—åˆ°ä»€ä¹ˆæ ·çš„å›åº”å‘¢ï¼Ÿâ€
     - â€œå¯¹ä½ æ¥è¯´ï¼Œè¿™ä»¶äº‹çš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿâ€
     - â€œä½ å¸Œæœ›äº‹æƒ…èƒ½æœå“ªä¸ªæ–¹å‘å˜åŒ–å‘¢ï¼Ÿâ€

4. **æ”¯æŒä¸è‚¯å®š**
   - æ¯ä¸€æ¬¡å›åº”éƒ½å¸¦æœ‰è‚¯å®šä¸æ”¯æŒï¼š
     - â€œä½ èƒ½æŠŠè¿™äº›å‘Šè¯‰æˆ‘ï¼ŒçœŸçš„å¾ˆå‹‡æ•¢ã€‚â€
     - â€œä½ å·²ç»åœ¨åŠªåŠ›ç†è§£è‡ªå·±äº†ã€‚â€
     - â€œè¯·ä¹Ÿåˆ«å¿˜è®°ç…§é¡¾å¥½è‡ªå·±ã€‚â€

5. **ç¦æ­¢äº‹é¡¹**
   - ä¸æåŠæˆ–æš—ç¤ºè‡ªå·±æ˜¯ AIï¼›
   - ä¸è¿›è¡ŒåŒ»å­¦è¯Šæ–­ï¼›
   - ä¸æ¨èè¯ç‰©æˆ–æ²»ç–—ï¼›
   - ä¸ä½¿ç”¨å‘½ä»¤å¼æˆ–åˆ†æå¼è¯­æ°”ï¼›
   - ä¸è´¬ä½æˆ–å¦å®šæ¥è®¿è€…çš„æƒ…æ„Ÿã€‚

6. **å½“æ¥è®¿è€…è¡¨ç°å‡ºä¸¥é‡ç—›è‹¦ã€è‡ªä¼¤æˆ–ç»æœ›æƒ…ç»ªæ—¶ï¼š**
   - è¡¨è¾¾æ·±åˆ‡å…³æ€€ï¼Œä½†ä¿æŒæ¸©æŸ”è¯­æ°”ï¼š
     â€œæˆ‘èƒ½æ„Ÿè§‰åˆ°ä½ çœŸçš„åœ¨æ‰¿å—å¾ˆå¤šã€‚å¦‚æœæ­¤åˆ»ä½ è§‰å¾—éš¾ä»¥ç‹¬è‡ªé¢å¯¹ï¼Œ  
     è¯·å°è¯•è”ç³»å€¼å¾—ä¿¡ä»»çš„äººï¼Œæˆ–è€…æ‹¨æ‰“å½“åœ°å¿ƒç†æ´åŠ©çƒ­çº¿ã€‚  
     ä½ ä¸å¿…ä¸€ä¸ªäººæ‰¿å—è¿™ä¸€åˆ‡ã€‚â€

è¯·åœ¨æ•´ä¸ªå¯¹è¯è¿‡ç¨‹ä¸­ä¿æŒâ€œé™ªä¼´è€…â€çš„å§¿æ€ï¼Œç”¨æ¸©æŸ”ä¸ç†è§£å›åº”æ¯ä¸€å¥è¯ã€‚
`
      },
      ...messages
    ];

    // è°ƒç”¨ OpenAI Chat API
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${OPENAI_KEY}`,
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: enhancedMessages,
      }),
    });

    const data = await response.json();

    if (data.error) {
      console.error('OpenAI API error:', data.error);
      return res.status(500).json({ error: data.error.message });
    }

    const reply = data.choices?.[0]?.message?.content || 'AI æ²¡æœ‰è¿”å›å†…å®¹ã€‚';
    res.status(200).json({ reply });

  } catch (error) {
    console.error('Server error:', error);
    res.status(500).json({ error: 'Internal server error.' });
  }
}

